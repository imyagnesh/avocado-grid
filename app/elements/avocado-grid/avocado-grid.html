<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../../bower_components/polymer/polymer.html">

<dom-module id="avocado-grid">
  <style>
    :host {
      /*display: block;*/
    @apply(--layout-horizontal);
    }

    [main] {
    @apply(--layout-flex);
    @apply(--layout-vertical);
    }

    [header] {
    @apply(--layout-horizontal);
    @apply(--layout-center);

    @apply(--paper-font-subhead);

      height: 40px;
      background-color: var(--google-blue-700);
      padding: 0 24px;
      color: white;
    }

    [body] {
    @apply(--layout-horizontal);
    @apply(--layout-center);
    @apply(--layout-fit);

    @apply(--paper-font-subhead);

      height: 40px;
      border-bottom : solid 1px #DDDDDD;
      /*background-color: var(--google-blue-700);*/
      padding: 0 24px;
      /*color: white;*/
      display: block;
      /*width: 100%;*/
      position: absolute;
      line-height: 40px;
    }

    [footer] {
    @apply(--layout-horizontal);
    @apply(--layout-center);
    @apply(--layout-end-justified);
    @apply(--layout-fixed-bottom);

    @apply(--paper-font-subhead);

      height: 48px;
      /*background-color: var(--google-blue-700);*/
      padding: 0 24px;
      /*color: white;*/
    }

    [tool] {
    @apply(--layout-inline);
    }

    [header] [content] {
      cursor: pointer;
    }

    [content] {
    @apply(--layout-flex);
      padding: 0 0 0 24px;
    }

    #virtual-scroll {
      @apply(--layout-scroll);
      width: 100%;
      max-height: 200px;
      /*overflow-y: auto;*/
      display: block;
      /*position: absolute;*/
    }

    #canvas {
      position: relative;
    }


    /*[card] {*/
    /*@apply(--layout-vertical);*/
    /*@apply(--layout-center-center);*/

    /*@apply(--shadow-elevation-2dp);*/

      /*height: 300px;*/
      /*max-width: 800px;*/
      /*margin: 16px auto;*/
      /*font-weight: bold;*/
      /*background-color: var(--paper-grey-200);*/
    /*}*/

    .dataTable {
      font-size: 15px;
      /* 12sp Roboto Medium, 54% black */
      /* 64dp card header height */
      /* 56do for last row */
      /* column padding */
      /* 48dp row height */
      /* 13sp Roboto Regular, 87% black */
      /* border separation color */
      /* INTERACTION */
    }

    .dataTable table {
      width: 100%;
    }

    .dataTable td {
      padding: 0;
      margin: 0;
    }

    .dataTable-header td {
      font-size: 12px;
      font-weight: 500;
      color: #757575;
      cursor: pointer;
      white-space: nowrap;
      /* when hoverSortIcons on a non-sorted column*/
      /* when hoverSortIcons on a sorted column*/
    }

    /*.dataTable th .hoverSortIcons ng-md-icon {*/
    /*visibility: hidden;*/
    /*fill: #b3b3b3;*/
    /*}*/

    /*.dataTable th:hover .hoverSortIcons ng-md-icon {*/
    /*visibility: visible;*/
    /*}*/

    /*.dataTable th .sortedColumn .hoverSortIcons ng-md-icon {*/
    /*display: none;*/
    /*}*/

    /*.dataTable th .sortedColumn ng-md-icon {*/
    /*fill: #212121;*/
    /*}*/

    /*.dataTable th svg {*/
    /*-webkit-transform: rotate(90deg);*/
    /*}*/

    /*.dataTable .dataTable-header, .dataTable .dataTable-header-alternate {*/
    /*height: 64px;*/
    /*padding-left: 24px;*/
    /*padding-right: 14px;*/
    /*}*/

    /*.dataTable .dataTable-header md-button, .dataTable .dataTable-header-alternate md-button {*/
    /*margin-left: 24px;*/
    /*}*/

    /*.dataTable .dataTable-header ng-md-icon, .dataTable .dataTable-header-alternate ng-md-icon {*/
    /*fill: #757575;*/
    /*}*/

    /*.dataTable .dataTable-header-alternate {*/
    /*background-color: #e3edfd;*/
    /*}*/

    /*.dataTable .dataTable-header-alternate .alternate-text {*/
    /*color: #0D47A1;*/
    /*}*/

    /*.dataTable tr th {*/
    /*height: 56px;*/
    /*}*/

    .dataTable .checkboxCell, .dataTable .menuCell {
      width: 18px;
      /*the next cell should not have just 24px padding */
    }

    .dataTable .checkboxCell paper-checkbox,
    .dataTable .menuCell paper-icon-button {
      margin: 0;
      padding: 0;
    }

    .dataTable td.checkboxCell,
    .dataTable th.checkboxCell,
    .dataTable td.menuCell,
    .dataTable th.menuCell {
      padding-left: 24px;
    }

    .dataTable tr td {
      height: 48px;
      font-size: 13px;
      color: #212121;
    }

    .dataTable td:first-child {
      padding: 0 0 0 24px;
    }

    .dataTable td:last-child {
      padding-right: 24px;
    }

    .dataTable .column {
      padding-left: 24px;
    }

    .dataTable .leftAlignedColumn {
      text-align: left;
    }

    .dataTable .rightAlignedColumn {
      text-align: right;
    }

    .dataTable .bottomAlignedColumn {
      vertical-align: bottom;
    }

    /*.dataTable-header tr td {*/
    /*border-bottom: solid 1px #DDDDDD;*/
    /*}*/

    .dataTable td {
      border-bottom: solid 1px #DDDDDD;
    }

    .dataTable-body tr:hover td {
      background: #EEEEEE;
    }

    .dataTable .selectedRow td {
      background: #F5F5F5;
    }

    paper-material {
      border-radius: 2px;
      height: 100%;
      padding: 16px 0px 16px 0px;
      width: calc(98.66% - 16px);
      margin: 16px auto;
      background: white;
    }
  </style>
  <template>
    <div main>
      <div header>
        <div tool><paper-checkbox checked="{{selectAll}}"></paper-checkbox></div>
        <template is="dom-repeat" id="gridList" items="{{grid}}" index-as="grid_no">
          <div content on-click="sortData">
            <div class="layout horizontal center">
              <div>{{item.label}}</div>
              <iron-icon icon="arrow-drop-down"></iron-icon>
            </div>
          </div>
        </template>
        <div tool>

        </div>
      </div>
      <div id="virtual-scroll" on-scroll="scrollData">
      <div id="canvas">
      <template is="dom-repeat" id="cellList" items="{{iCell}}" as="data">
      <div body class="renderer">
        <div tool>
          <paper-checkbox checked="{{selectAll}}"></paper-checkbox>
        </div>
        <template is="dom-repeat" items="{{grid}}" as="header">
          <div content>
            <bind-json grid="{{data}}" binding="{{header}}" read-only="{{readOnly}}"></bind-json>
          </div>
        </template>
        <div tool>
          <paper-icon-button icon="delete" on-click="deleteItem"></paper-icon-button>
        </div>
      </div>
      </template>
      <template is="dom-if" if="{{insertItem}}">
        <div body class="renderer">
        <div tool>
          <paper-checkbox checked="{{selectAll}}"></paper-checkbox>
        </div>
        <template is="dom-repeat" items="{{grid}}" as="header">
          <div content>
            <bind-json binding="{{header}}" read-only="{{readOnly}}"></bind-json>
          </div>
        </template>
        <div tool>
          <paper-icon-button icon="delete" on-click="removeItem"></paper-icon-button>
        </div>
      </div>
      </template>
      </div>
      </div>
      <template is="dom-if" if="{{!readOnly}}">
      <div footer>
      <paper-icon-button icon="add" on-click="addItem"></paper-icon-button>
      </div>
      </template>
    </div>
  </template>
</dom-module>
<script>
  (function () {
    Polymer({
      is: 'avocado-grid',

      properties: {

        grid: {
          type: Array
        },

        cell: {
          type: Array
        },

        iCell:{
          type: Array,
          notify: true
        },

        selectAll: {
          type: Boolean
        },

        readOnly: {
          type: Boolean,
          value: false
        },

        height: {
          type: Number,
          value: 200
        },

        rowHeight: {
          type: Number,
          value: 40
        },

        cellsPerPage: {
          type: Number,
          computed: 'computeCellsPerPage(height, rowHeight)'
        },

        numberOfCells: {
          type: Number,
          computed: 'computeNumberOfCells(cellsPerPage)'
        },

        scrollTop: {
          type: Number,
          value: 0,
          notify: true,
          observer: 'changeScrollPosition'
        },

        insertItem: {
          type:Boolean,
          value: false,
          notify: true
        }


      },

      observers: [
        'updateData(grid, cell)'
      ],

      updateData: function(grid, cell) {
        this.changeScrollPosition(0);
      },


      computeCellsPerPage: function (height, rowHeight) {
        return Math.round(height / rowHeight);
      },

      computeNumberOfCells: function (cellsPerPage) {
        return 3 * cellsPerPage;
      },

      scrollData: function () {
        this.scrollTop = this.$$('#virtual-scroll').scrollTop;
      },

      changeScrollPosition: function (newValue) {
        var self = this;
        var firstCell = Math.max(Math.floor(newValue / self.rowHeight) - self.cellsPerPage, 0);
        var cellsToCreate = Math.min(firstCell + self.numberOfCells, self.numberOfCells);
        var searchResult = self.getIndexData(firstCell, firstCell + cellsToCreate);
//        if (searchResult.data.length > 0) {
//          this.noResultFound = true;
//        }
//        else {
//          this.noResultFound = false;
//        }
        self.iCell = searchResult;
        self.async(function () {
          var ironSelector = Polymer.dom(self.root).querySelector('#canvas');
          var height =  5;
          if(self.cell != undefined)
          {
            height += (self.cell.length * self.rowHeight);
          }
          if(self.insertItem)
          {
            height += self.rowHeight;
          }
          ironSelector.setAttribute('style', 'height: ' + height + 'px;');
          var childNodes = Polymer.dom(self.root).querySelectorAll('.renderer');
          for (var i = 0; i < childNodes.length; i++) {
            childNodes[i].setAttribute('style', 'top: ' + ((firstCell + i) * self.rowHeight) + 'px;');
          }
        })

      },


      getIndexData: function ( startIndex, endIndex) {
        return _.slice(this.cell, startIndex, endIndex);
      },

      sortData: function (e) {
        var item = this.$.gridList.itemForElement(e.target);
        this.cell = _.sortByOrder(this.cell, [item.binding], ['asc']);
        this.$$('#virtual-scroll').scrollTop = 0;
      },

      deleteItem: function (e) {
        var item = this.$.cellList.itemForElement(e.target);
        this.cell = _.reject(this.cell, item);
        this.changeScrollPosition(this.$$('#virtual-scroll').scrollTop);
      },

      addItem: function (e) {
        this.insertItem = true;
        var ironSelector = Polymer.dom(this.root).querySelector('#canvas');
        ironSelector.setAttribute('style', 'height: ' + (this.$$('#virtual-scroll').scrollHeight + this.rowHeight) + 'px;');
        this.$$('#virtual-scroll').scrollTop = this.$$('#virtual-scroll').scrollHeight;
      },

      removeItem: function (e) {
        this.insertItem = false;
        var ironSelector = Polymer.dom(this.root).querySelector('#canvas');
        ironSelector.setAttribute('style', 'height: ' + (this.$$('#virtual-scroll').scrollHeight - this.rowHeight) + 'px;');
        this.$$('#virtual-scroll').scrollTop = this.$$('#virtual-scroll').scrollHeight;
      }


    });
  })();
</script>
